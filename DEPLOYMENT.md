#  Music Discovery API - Complete Deployment Guide

## Table of Contents
1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Deployment Steps (Outside Codespace)](#deployment-steps-outside-codespace)
4. [CI/CD Pipeline Setup](#cicd-pipeline-setup)
5. [Environment Variables & Secrets](#environment-variables--secrets)
6. [Verification & Testing](#verification--testing)
7. [Monitoring & Logs](#monitoring--logs)
8. [Troubleshooting](#troubleshooting)

---

## Overview

This guide walks you through deploying the Music Discovery API to Render with a complete CI/CD pipeline using GitHub Actions. The deployment includes:

-  **Automated Testing**: Unit tests, integration tests, and code quality checks
-  **Security Scanning**: Vulnerability checks with Safety and Bandit
-  **Automated Deployment**: Push to main branch triggers automatic deployment
-  **Health Monitoring**: Automated health checks and smoke tests
-  **Secrets Management**: Secure handling of API keys and credentials
-  **Database & Cache**: PostgreSQL and Redis automatically provisioned
-  **Protected Endpoints**: OAuth2 authentication enforced in production

---

## Prerequisites

Before starting, ensure you have:

1. **GitHub Account** with this repository
2. **Render Account** (free tier available at https://render.com)
3. **Spotify Developer Account** (https://developer.spotify.com)
4. **Local Git** configured with your repository

---

## Deployment Steps (Outside Codespace)

### Step 1: Set Up Spotify Application

** Do this outside the codespace - in your browser:**

1. Go to https://developer.spotify.com/dashboard
2. Log in with your Spotify account
3. Click **"Create app"**
4. Fill in the details:
   - **App name**: Music Discovery API
   - **App description**: Music discovery and playlist management
   - **Redirect URI**: `https://music-discovery-api.onrender.com/api/auth/callback`
     (You'll update this after getting your Render URL)
   - **APIs used**: Web API
5. Click **"Save"**
6. In the app dashboard, click **"Settings"**
7. **Copy and save** your:
   - **Client ID**
   - **Client Secret** (click "View client secret")

>  **Important**: Keep these credentials secure! Never commit them to your repository.

---

### Step 2: Connect Repository to Render

** Do this outside the codespace - in Render dashboard:**

1. Go to https://dashboard.render.com
2. Click **"New +"** â†’ **"Blueprint"**
3. Click **"Connect GitHub"** (or use existing connection)
4. Select your repository: `music-discovery-api`
5. Click **"Connect"**
6. Render will detect the `render.yaml` file
7. Review the services to be created:
   -  Web Service: `music-discovery-api`
   -  PostgreSQL: `music-discovery-db`
   -  Redis: `music-discovery-redis`
8. Click **"Apply"**

Render will now provision all services. This takes 5-10 minutes.

---

### Step 3: Configure Environment Variables

** Do this in Render dashboard after services are created:**

1. Go to your web service: `music-discovery-api`
2. Click **"Environment"** in the left sidebar
3. **Add/Update** these environment variables:

#### Required Variables (Manual Setup):

```
SPOTIFY_CLIENT_ID=<paste-your-spotify-client-id>
SPOTIFY_CLIENT_SECRET=<paste-your-spotify-client-secret>
```

#### Update Redirect URI:

After first deployment, copy your Render URL (e.g., `https://music-discovery-api-xyz.onrender.com`)

4. Update the `SPOTIFY_REDIRECT_URI` variable:
```
SPOTIFY_REDIRECT_URI=https://<your-render-url>/api/auth/callback
```

5. **Also update** this in your Spotify Developer Dashboard:
   - Go to https://developer.spotify.com/dashboard
   - Open your app â†’ Settings
   - Update Redirect URIs with your new Render URL

6. Click **"Save Changes"** in Render

#### Auto-Generated Variables (Already Set):
-  `JWT_SECRET` - Auto-generated by Render
-  `CRYPTO_KEY` - Auto-generated by Render
-  `DATABASE_URL` - Auto-linked to PostgreSQL
-  `REDIS_URL` - Auto-linked to Redis

---

### Step 4: Trigger First Deployment

** Do this in Render dashboard:**

1. Go to your web service dashboard
2. Click **"Manual Deploy"** â†’ **"Deploy latest commit"**
3. Watch the deployment logs in real-time
4. Wait for status to change to **"Live"** (green)
5. Click the service URL to test: `https://your-app.onrender.com`

You should see:
```json
{
  "message": "Music Discovery API â€” FastAPI",
  "version": "v1",
  "docs": "/docs",
  "health": "/api/health/live"
}
```

---

### Step 5: Set Up GitHub Actions CI/CD

** Do this in GitHub repository settings:**

1. Go to your GitHub repository
2. Click **"Settings"** â†’ **"Secrets and variables"** â†’ **"Actions"**
3. Click **"New repository secret"**

#### Add these secrets:

**Secret 1: RENDER_API_KEY**
- Go to Render Dashboard â†’ Account Settings â†’ API Keys
- Click **"Create API Key"**
- Copy the key
- In GitHub, create secret:
  - Name: `RENDER_API_KEY`
  - Value: `<paste-render-api-key>`

**Secret 2: RENDER_SERVICE_ID**
- In Render, go to your web service
- Look at the URL: `https://dashboard.render.com/web/srv-XXXXX`
- Copy the service ID (the `srv-XXXXX` part)
- In GitHub, create secret:
  - Name: `RENDER_SERVICE_ID`
  - Value: `srv-XXXXX`

4. Click **"Add secret"** for each

---

### Step 6: Test CI/CD Pipeline

**ðŸ’» Do this from your local machine or codespace:**

1. Make a small change (e.g., update README.md)
2. Commit and push to main:
```bash
git add .
git commit -m "Test CI/CD pipeline"
git push origin main
```

3. **Watch the pipeline run:**
   - Go to GitHub repository â†’ **"Actions"** tab
   - Click on the running workflow
   - Monitor each job:
     -  Code Quality Checks
     -  Security Scan
     -  Run Tests
     -  Validate Build
     -  Deploy to Render
     -  Smoke Tests

4. Once complete, verify deployment:
   - Visit your Render URL
   - Check `/api/health/live` endpoint
   - Open `/docs` for interactive API documentation

---

## CI/CD Pipeline Setup

### Pipeline Overview

The GitHub Actions pipeline runs automatically on every push to `main`:

1. **Lint** - Code quality checks (Black, isort, flake8)
2. **Security** - Vulnerability scanning (Safety, Bandit)
3. **Test** - Run test suite with coverage
4. **Build** - Validate dependencies
5. **Deploy** - Deploy to Render (only on main branch)
6. **Smoke Tests** - Verify production endpoints

### What Gets Tested

1. **Code Quality**:
   - Black formatting
   - isort import sorting
   - flake8 linting

2. **Security**:
   - Safety (dependency vulnerabilities)
   - Bandit (code security issues)

3. **Functional Tests**:
   - Unit tests
   - Integration tests
   - API endpoint tests
   - Authentication enforcement
   - Database operations

4. **Post-Deployment**:
   - Health check verification
   - Public endpoint accessibility
   - Protected endpoint authentication

---

## Environment Variables & Secrets

### Production Environment Variables

**Auto-configured by Render:**
- `DATABASE_URL` - PostgreSQL connection string (auto-linked from database service)
- `REDIS_URL` - Redis connection string (auto-linked from Redis service)
- `JWT_SECRET` - JWT token signing key (auto-generated secure value)
- `CRYPTO_KEY` - Token encryption key (auto-generated secure value)

**Manual configuration required:**
- `SPOTIFY_CLIENT_ID` - Your Spotify app client ID from developer dashboard
- `SPOTIFY_CLIENT_SECRET` - Your Spotify app secret from developer dashboard
- `SPOTIFY_REDIRECT_URI` - OAuth callback URL (update with your actual Render URL)

**Optional:**
- `LOG_LEVEL` - Logging verbosity (default: INFO)
- `ENVIRONMENT` - Environment name (default: production)

### GitHub Secrets (for CI/CD)

You need to add two secrets to your GitHub repository for the CI/CD pipeline:

- `RENDER_API_KEY` - Used to trigger deployments to Render. Get it from Render Dashboard â†’ Account Settings â†’ API Keys.
- `RENDER_SERVICE_ID` - Identifies which service to deploy. Found in your service URL: `srv-XXXXX`.

---

## Verification & Testing

### Manual Testing

**1. Test Public Endpoints:**
```bash
# Root endpoint
curl https://your-app.onrender.com/

# Health checks
curl https://your-app.onrender.com/api/health/live
curl https://your-app.onrender.com/api/health/ready

# API Documentation
open https://your-app.onrender.com/docs
```

**2. Test Authentication:**
```bash
# Should return 401 (Unauthorized)
curl https://your-app.onrender.com/api/playlists/me

# Initiate OAuth flow
open https://your-app.onrender.com/api/auth/login
```

**3. Test Complete OAuth Flow:**
1. Visit: `https://your-app.onrender.com/api/auth/login`
2. Authorize with Spotify
3. Get redirected with JWT token
4. Use token to access protected endpoints

### Automated Testing Script

Run the verification script:
```bash
chmod +x scripts/verify_deployment.sh
./scripts/verify_deployment.sh https://your-app.onrender.com
```

---

## Monitoring & Logs

### View Logs in Render

** In Render Dashboard:**

1. Go to your service: `music-discovery-api`
2. Click **"Logs"** tab
3. View real-time logs with filtering options

### Key Log Patterns

```
 Successful request:
INFO: Completed request: GET /api/health/live status=200 duration=0.023s

 Authentication failure:
WARNING: Unauthorized access attempt: GET /api/playlists/me

 OAuth flow:
INFO: OAuth callback received for user: user_spotify_id
```

### Health Monitoring

Render automatically monitors:
- **Liveness**: `/api/health/live` (every 30s)
- **Crashes**: Auto-restarts on failure
- **Metrics**: CPU, Memory, Response times

---

## Troubleshooting

### Common Issues

#### 1. Deployment Fails with "Build failed"

**Solution:**
```bash
# Check logs in Render Dashboard
# Common causes:
- Missing dependencies in requirements.txt
- Database initialization errors
- Python version mismatch
```

#### 2. OAuth Callback Error

**Problem**: `redirect_uri_mismatch`

**Solution:**
- Verify `SPOTIFY_REDIRECT_URI` matches exactly in:
  1. Render environment variables
  2. Spotify Developer Dashboard settings
- Ensure HTTPS (not HTTP)
- No trailing slash

#### 3. Database Connection Error

**Problem**: `could not connect to database`

**Solution:**
```bash
# Verify DATABASE_URL is set correctly
# Check database service is running
# View database logs in Render
```

#### 4. Protected Endpoints Return 401

**Problem**: Valid JWT token rejected

**Solution:**
- Check `JWT_SECRET` hasn't changed
- Verify token not expired (60 min lifetime)
- Ensure Authorization header format: `Bearer <token>`

#### 5. CI/CD Pipeline Fails

**Problem**: GitHub Actions fails

**Solution:**
- Check secrets are set correctly in GitHub
- Verify RENDER_SERVICE_ID format: `srv-xxxxx`
- Review workflow logs for specific error
- Ensure tests pass locally first

---

## Deployment Summary

### What You've Accomplished

 **Infrastructure as Code**: `render.yaml` defines all services
 **Automated CI/CD**: GitHub Actions pipeline for testing and deployment
 **Security**: Secrets management, vulnerability scanning, auth enforcement
 **Monitoring**: Health checks, logging, automated alerts
 **Scalability**: Database, cache, and web service ready to scale
 **Documentation**: API docs auto-generated at `/docs`

### Deployment Architecture

**GitHub Repository** â†’ **Render Platform** â†’ **Spotify Web API**

**GitHub Actions CI/CD Pipeline:**
- Lint & Security Scan
- Run Tests with Coverage
- Trigger Render Deployment
- Smoke Tests

**Render Platform Services:**
- Web Service (music-discovery-api): Python 3.12 + FastAPI, auto-scaling, HTTPS enabled, health monitoring
- PostgreSQL Database: Persistent data storage
- Redis Cache: Response caching

**External Integration:**
- Spotify Web API: Authentication, music data, playlist management

### Next Steps

1. **Monitor Your Deployment**:
   - Check Render dashboard regularly
   - Review logs for errors or warnings
   - Monitor response times and resource usage

2. **Scale as Needed**:
   - Upgrade Render plan for higher traffic
   - Add custom domain
   - Enable auto-scaling

3. **Enhance CI/CD**:
   - Add staging environment
   - Implement blue-green deployments
   - Add performance testing

4. **Improve Security**:
   - Enable rate limiting per user
   - Add API key rotation
   - Implement audit logging

---

## Support & Resources

- **Render Documentation**: https://render.com/docs
- **FastAPI Documentation**: https://fastapi.tiangolo.com
- **Spotify API Documentation**: https://developer.spotify.com/documentation/web-api
- **GitHub Actions**: https://docs.github.com/actions

---

** Congratulations!** Your Music Discovery API is now deployed with enterprise-grade CI/CD automation!
- `LOG_LEVEL` - Logging level (default: `INFO`, options: `DEBUG`, `WARNING`, `ERROR`)
- `ENVIRONMENT` - Environment name (default: `production`)
- `WRITE_API_KEY` - API key for write operations (if using API key auth)

---

## Database Initialization

The database schema is automatically created on first deploy via `scripts/init_postgres.py`.

To manually initialize:
```bash
python scripts/init_postgres.py
```

This creates:
- `playlists` table with `userId` index
- `user_tokens` table for OAuth tokens

---

## Health Checks

- **Liveness:** `GET /api/health/live` - Returns 200 if service is running
- **Readiness:** `GET /api/health/ready` - Returns 200 if service can accept traffic

---

## Scaling

### Render
- Auto-scales based on traffic
- Configure in Render dashboard

### Kubernetes
- HPA configured for 3-10 replicas
- Scales on CPU (70%) and Memory (80%) utilization
- Modify `k8s-deployment.yaml` HorizontalPodAutoscaler section

---

## Monitoring

### Logs
**Render:** View in dashboard or use Render CLI
```bash
render logs -s music-discovery-api
```

**Kubernetes:**
```bash
kubectl logs -l app=music-discovery-api -f
```

### Metrics
All logs are JSON-structured for easy parsing by:
- Datadog
- New Relic
- CloudWatch
- Stackdriver

---

## Troubleshooting

### Database Connection Issues
1. Verify `DATABASE_URL` is set correctly
2. Check PostgreSQL is running and accessible
3. Confirm connection string format: `postgresql://` (not `postgres://`)

### Spotify OAuth Errors
1. Verify redirect URI matches exactly in Spotify Dashboard
2. Check `SPOTIFY_CLIENT_ID` and `SPOTIFY_CLIENT_SECRET`
3. Ensure domain is whitelisted in Spotify app settings

### 503 Service Unavailable
- Database connection failed
- Run `python scripts/init_postgres.py` to initialize schema
